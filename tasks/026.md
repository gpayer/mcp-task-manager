---
id: 26
parent_id: 18
title: 'Task 8: Add integration tests for smart directory discovery'
status: todo
priority: medium
type: feature
created_at: "2026-01-13T09:33:11Z"
updated_at: "2026-01-13T09:33:11Z"
---

**Files:**
- Modify: `internal/config/config_test.go`

**Steps:**
1. Write tests for FindProjectRoot:
   - Test finds mcp-tasks.yaml in current directory
   - Test finds mcp-tasks.yaml in parent directory
   - Test finds tasks/ directory when no config
   - Test mcp-tasks.yaml takes precedence over tasks/ at same level
   - Test returns empty string when nothing found
2. Write tests for Load() with upward search:
   - Test ProjectFound=true when project found
   - Test ProjectFound=false when nothing found
   - Test MCP_TASKS_DIR overrides search
3. Run all tests: `go test ./internal/config/... -v`
4. Commit with message: `test(config): add comprehensive tests for directory discovery`

**Code:**

```go
func TestFindProjectRoot_ConfigInCwd(t *testing.T) {
    dir := t.TempDir()
    oldWd, _ := os.Getwd()
    defer os.Chdir(oldWd)
    os.Chdir(dir)
    
    // Create config file
    os.WriteFile(filepath.Join(dir, "mcp-tasks.yaml"), []byte("task_types: [feature]"), 0644)
    
    root, err := FindProjectRoot()
    if err != nil {
        t.Fatalf("FindProjectRoot() error = %v", err)
    }
    if root != dir {
        t.Errorf("FindProjectRoot() = %q, want %q", root, dir)
    }
}

func TestFindProjectRoot_ConfigInParent(t *testing.T) {
    dir := t.TempDir()
    subdir := filepath.Join(dir, "subdir")
    os.MkdirAll(subdir, 0755)
    
    oldWd, _ := os.Getwd()
    defer os.Chdir(oldWd)
    os.Chdir(subdir)
    
    // Create config in parent
    os.WriteFile(filepath.Join(dir, "mcp-tasks.yaml"), []byte("task_types: [feature]"), 0644)
    
    root, err := FindProjectRoot()
    if err != nil {
        t.Fatalf("FindProjectRoot() error = %v", err)
    }
    if root != dir {
        t.Errorf("FindProjectRoot() = %q, want %q", root, dir)
    }
}

func TestFindProjectRoot_TasksDir(t *testing.T) {
    dir := t.TempDir()
    oldWd, _ := os.Getwd()
    defer os.Chdir(oldWd)
    os.Chdir(dir)
    
    // Create tasks directory
    os.MkdirAll(filepath.Join(dir, "tasks"), 0755)
    
    root, err := FindProjectRoot()
    if err != nil {
        t.Fatalf("FindProjectRoot() error = %v", err)
    }
    if root != dir {
        t.Errorf("FindProjectRoot() = %q, want %q", root, dir)
    }
}

func TestFindProjectRoot_ConfigPrecedence(t *testing.T) {
    dir := t.TempDir()
    oldWd, _ := os.Getwd()
    defer os.Chdir(oldWd)
    os.Chdir(dir)
    
    // Create both config and tasks dir
    os.WriteFile(filepath.Join(dir, "mcp-tasks.yaml"), []byte("task_types: [feature]"), 0644)
    os.MkdirAll(filepath.Join(dir, "tasks"), 0755)
    
    root, err := FindProjectRoot()
    if err != nil {
        t.Fatalf("FindProjectRoot() error = %v", err)
    }
    // Should find config first (same directory, config has precedence)
    if root != dir {
        t.Errorf("FindProjectRoot() = %q, want %q", root, dir)
    }
}

func TestFindProjectRoot_NotFound(t *testing.T) {
    dir := t.TempDir()
    oldWd, _ := os.Getwd()
    defer os.Chdir(oldWd)
    os.Chdir(dir)
    
    // Don't create anything
    root, err := FindProjectRoot()
    if err != nil {
        t.Fatalf("FindProjectRoot() error = %v", err)
    }
    if root != "" {
        t.Errorf("FindProjectRoot() = %q, want empty string", root)
    }
}

func TestLoad_ProjectFound(t *testing.T) {
    dir := t.TempDir()
    oldWd, _ := os.Getwd()
    defer os.Chdir(oldWd)
    os.Chdir(dir)
    
    // Save and restore env
    oldEnv := os.Getenv("MCP_TASKS_DIR")
    defer os.Setenv("MCP_TASKS_DIR", oldEnv)
    os.Unsetenv("MCP_TASKS_DIR")
    
    // Create tasks directory
    os.MkdirAll(filepath.Join(dir, "tasks"), 0755)
    
    cfg, err := Load()
    if err != nil {
        t.Fatalf("Load() error = %v", err)
    }
    if !cfg.ProjectFound {
        t.Error("Load() ProjectFound = false, want true")
    }
}

func TestLoad_ProjectNotFound(t *testing.T) {
    dir := t.TempDir()
    oldWd, _ := os.Getwd()
    defer os.Chdir(oldWd)
    os.Chdir(dir)
    
    // Save and restore env
    oldEnv := os.Getenv("MCP_TASKS_DIR")
    defer os.Setenv("MCP_TASKS_DIR", oldEnv)
    os.Unsetenv("MCP_TASKS_DIR")
    
    // Don't create anything
    cfg, err := Load()
    if err != nil {
        t.Fatalf("Load() error = %v", err)
    }
    if cfg.ProjectFound {
        t.Error("Load() ProjectFound = true, want false")
    }
}
```

**Verification:**
`go test ./internal/config/... -v`