---
id: 21
parent_id: 18
title: 'Task 3: Remove auto-EnsureDir from storage Save and update service'
status: done
priority: medium
type: feature
created_at: "2026-01-13T09:32:06Z"
updated_at: "2026-01-13T09:57:36Z"
---

**Files:**
- Modify: `internal/storage/markdown.go`
- Modify: `internal/task/service.go`
- Test: `internal/task/service_test.go`

**Steps:**
1. Write failing test for Create() ensuring directory when ProjectFound=false
2. Run tests to verify failure: `go test ./internal/task/...`
3. Remove the `s.EnsureDir()` call from `MarkdownStorage.Save()` (line 39)
4. Update `Service` struct to hold a reference to config
5. Modify `NewService()` to accept config
6. Update `Service.Create()` to call `s.storage.EnsureDir()` only when creating tasks (this is the write operation that should create the directory)
7. Update `Service.Initialize()` to not call `EnsureDir()` - only load index if directory exists
8. Run tests to verify pass: `go test ./internal/task/...`
9. Commit with message: `feat(storage): move directory creation to write operations only`

**Code:**

Remove from markdown.go Save():
```go
// Before:
func (s *MarkdownStorage) Save(t *task.Task) error {
    if err := s.EnsureDir(); err != nil {  // REMOVE THIS
        return err
    }
    // ...
}

// After:
func (s *MarkdownStorage) Save(t *task.Task) error {
    // Build frontmatter (directly, no EnsureDir)
    // ...
}
```

Update service.go:
```go
type Service struct {
    storage    Storage
    index      Index
    validTypes []string
    config     *config.Config  // Add config reference
}

func NewService(storage Storage, index Index, validTypes []string, cfg *config.Config) *Service {
    return &Service{
        storage:    storage,
        index:      index,
        validTypes: validTypes,
        config:     cfg,
    }
}

func (s *Service) Initialize() error {
    // Only load index if directory exists, don't create it
    return s.index.Load()
}

func (s *Service) Create(title, description string, priority Priority, taskType string, parentID *int) (*Task, error) {
    // Ensure directory exists for write operation
    if err := s.storage.EnsureDir(); err != nil {
        return nil, err
    }
    // ... rest of create logic
}
```

**Verification:**
`go test ./internal/task/... -v && go test ./internal/storage/... -v`