---
id: 31
parent_id: 27
title: 'Task 4: Update task.Index interface and service layer'
status: done
priority: medium
type: feature
created_at: "2026-01-25T14:07:40Z"
updated_at: "2026-01-25T15:14:58Z"
---

**Files:**
- Modify: `internal/task/service.go`
- Test: `internal/task/service_test.go`

**Steps:**
1. The Index interface in `internal/task/service.go` needs to be updated. The current interface has `Get(id int) (*Task, bool)` which now loads from disk. We need to add `GetEntry` for metadata-only access.

Update the Index interface:

```go
// Index interface for task indexing
type Index interface {
    Load() error
    Save() error
    Get(id int) (*Task, bool)           // Full task with description (loads from disk)
    GetEntry(id int) (interface{}, bool) // Metadata only (from memory) - returns *storage.IndexEntry but we use interface{} to avoid import cycle
    Set(t *Task)
    Delete(id int)
    All() []*Task
    Filter(status *Status, priority *Priority, taskType *string, parentID *int) []*Task
    NextTodo() *Task
    NextID() int
    // Subtask methods
    GetSubtasks(parentID int) []*Task
    HasSubtasks(taskID int) bool
    SubtaskCounts(parentID int) (total int, done int)
}
```

Actually, to avoid import cycles and keep it simple, we can keep the interface as-is. The key change is that `Get()` now loads from disk, but that's internal to the Index implementation. The service layer doesn't need to change its interface usage.

2. Review service methods that use `index.Get()`:
   - `Create()` - uses Get to validate parent exists - this is fine, but could use GetEntry for efficiency
   - `Get()` - returns full task - uses index.Get() which now loads from disk - correct behavior
   - `GetWithSubtasks()` - calls Get() and GetSubtasks() - correct, will load full tasks
   - `Update()` - calls Get() to get full task, then saves - correct
   - `Delete()` - calls Get() to verify task exists - could be optimized but fine
   - `StartTask()` - calls Get() multiple times - correct
   - `CompleteTask()` - calls Get() - correct

3. The service layer should work as-is. Write a test to verify that List() returns tasks without descriptions:

```go
func TestService_List_OmitsDescriptions(t *testing.T) {
    // Setup with mock or real storage
    dir := t.TempDir()
    storage := &mockStorage{dir: dir}
    index := &mockIndex{}
    cfg := &config.Config{ProjectFound: true}
    svc := NewService(storage, index, []string{"feature", "bug"}, cfg)

    // Create task with description
    created, err := svc.Create("Task with description", "This is a long description", PriorityHigh, "feature", nil)
    if err != nil {
        t.Fatalf("Create() error = %v", err)
    }

    // List should return task without description (or empty description)
    tasks := svc.List(nil, nil, nil, nil)
    if len(tasks) != 1 {
        t.Fatalf("List() returned %d tasks, want 1", len(tasks))
    }

    // The task returned by List() comes from index.Filter() which now returns
    // tasks converted from IndexEntry (no description)
    // However, to fully test this, we need the real Index implementation

    // Verify Get() returns full description
    fetched, err := svc.Get(created.ID)
    if err != nil {
        t.Fatalf("Get() error = %v", err)
    }
    if fetched.Description != "This is a long description" {
        t.Errorf("Get() description = %q, want full description", fetched.Description)
    }
}
```

4. Actually, the existing tests should already verify this behavior works. The key insight is:
   - `List()` calls `index.Filter()` which returns tasks converted from entries (no description)
   - `Get()` calls `index.Get()` which now loads from disk (full description)

5. Run service tests: `go test ./internal/task/... -v`

6. Run all tests to ensure nothing broke: `go test ./... -v`

7. Commit with message: `docs(service): update comments for lazy description loading`

**Note:** This task is primarily verification that the service layer works correctly with the new Index behavior. The interface changes happened in Task 2 and 3. If all tests pass, no code changes may be needed.

**Verification:**
`go test ./... -v`