---
id: 25
parent_id: 18
title: 'Task 7: Update main.go and all callers to pass config to NewService'
status: todo
priority: medium
type: feature
created_at: "2026-01-13T09:32:52Z"
updated_at: "2026-01-13T09:32:52Z"
---

**Files:**
- Modify: `cmd/mcp-task-manager/main.go`
- Modify: `internal/cli/commands.go`
- Modify: `internal/task/service_test.go`

**Steps:**
1. Update main.go to pass config to NewService
2. Update initService() in commands.go to pass config to NewService
3. Update all test files that create Service instances to pass config
4. Run all tests: `go test ./...`
5. Verify build: `go build ./cmd/mcp-task-manager`
6. Commit with message: `refactor: pass config to NewService for project discovery`

**Code:**

Update main.go:
```go
func main() {
    // CLI mode if any arguments provided
    if len(os.Args) > 1 {
        cli.Run()
        return
    }

    // MCP server mode
    // Load configuration
    cfg, err := config.Load()
    if err != nil {
        log.Fatalf("Failed to load config: %v", err)
    }

    // Initialize storage
    tasksDir := cfg.TasksDir()
    mdStorage := storage.NewMarkdownStorage(tasksDir)
    index := storage.NewIndex(tasksDir, mdStorage)

    // Initialize task service (pass config)
    svc := task.NewService(mdStorage, index, cfg.TaskTypes, cfg)  // Added cfg
    if err := svc.Initialize(); err != nil {
        log.Fatalf("Failed to initialize service: %v", err)
    }

    // ... rest unchanged
}
```

Update commands.go initService():
```go
func initService() (*task.Service, *config.Config, error) {
    cfg, err := config.Load()
    if err != nil {
        return nil, nil, fmt.Errorf("failed to load config: %w", err)
    }

    tasksDir := cfg.TasksDir()
    mdStorage := storage.NewMarkdownStorage(tasksDir)
    index := storage.NewIndex(tasksDir, mdStorage)
    svc := task.NewService(mdStorage, index, cfg.TaskTypes, cfg)  // Added cfg

    if err := svc.Initialize(); err != nil {
        return nil, nil, fmt.Errorf("failed to initialize: %w", err)
    }

    return svc, cfg, nil
}
```

Update service_test.go (example helper):
```go
func newTestService(t *testing.T) (*Service, string) {
    dir := t.TempDir()
    cfg := &config.Config{
        DataDir:      dir,
        ProjectFound: true,
        TaskTypes:    []string{"feature", "bug"},
    }
    storage := // ... create storage
    index := // ... create index
    svc := NewService(storage, index, cfg.TaskTypes, cfg)
    return svc, dir
}
```

**Verification:**
`go test ./... && go build ./cmd/mcp-task-manager`