---
id: 28
parent_id: 27
title: 'Task 1: Add IndexEntry and IndexFile types with git commit detection'
status: done
priority: medium
type: feature
created_at: "2026-01-25T14:06:34Z"
updated_at: "2026-01-25T14:28:30Z"
---

**Files:**
- Modify: `internal/storage/index.go`
- Test: `internal/storage/storage_test.go`

**Steps:**
1. Write failing test for `getGitCommit()` function
2. Run test to verify failure: `go test ./internal/storage/... -run TestGetGitCommit -v`
3. Implement `getGitCommit()` function that:
   - Walks up from dir to find `.git` directory
   - Runs `git rev-parse HEAD`
   - Returns commit hash or empty string if not a git repo
4. Run test to verify pass: `go test ./internal/storage/... -run TestGetGitCommit -v`
5. Add new types (no test needed, just type definitions):

```go
// IndexEntry contains task metadata without description (stored in index)
type IndexEntry struct {
    ID        int           `json:"id"`
    ParentID  *int          `json:"parent_id,omitempty"`
    Title     string        `json:"title"`
    Status    task.Status   `json:"status"`
    Priority  task.Priority `json:"priority"`
    Type      string        `json:"type"`
    CreatedAt time.Time     `json:"created_at"`
    UpdatedAt time.Time     `json:"updated_at"`
}

// IndexFile is the on-disk format for the index
type IndexFile struct {
    GitCommit string        `json:"git_commit"`
    Tasks     []*IndexEntry `json:"tasks"`
}
```

6. Add helper function to convert Task to IndexEntry:

```go
func taskToEntry(t *task.Task) *IndexEntry {
    return &IndexEntry{
        ID:        t.ID,
        ParentID:  t.ParentID,
        Title:     t.Title,
        Status:    t.Status,
        Priority:  t.Priority,
        Type:      t.Type,
        CreatedAt: t.CreatedAt,
        UpdatedAt: t.UpdatedAt,
    }
}
```

7. Commit with message: `feat(storage): add IndexEntry, IndexFile types and getGitCommit helper`

**Test code for getGitCommit:**

```go
func TestGetGitCommit(t *testing.T) {
    // Test in non-git directory
    dir := t.TempDir()
    commit, err := getGitCommit(dir)
    if err != nil {
        t.Fatalf("getGitCommit() in non-git dir error = %v", err)
    }
    if commit != "" {
        t.Errorf("getGitCommit() in non-git dir = %q, want empty", commit)
    }

    // Test in git directory (use the actual project dir)
    // The test is running inside a git repo, so cwd should work
    commit, err = getGitCommit(".")
    if err != nil {
        t.Fatalf("getGitCommit() error = %v", err)
    }
    if commit == "" {
        t.Error("getGitCommit() in git repo returned empty string")
    }
    if len(commit) != 40 {
        t.Errorf("getGitCommit() returned %q, want 40-char SHA", commit)
    }
}
```

**Verification:**
`go test ./internal/storage/... -v`