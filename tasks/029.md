---
id: 29
parent_id: 27
title: 'Task 2: Refactor Index to use IndexEntry internally'
status: in_progress
priority: medium
type: feature
created_at: "2026-01-25T14:06:51Z"
updated_at: "2026-01-25T14:28:37Z"
---

**Files:**
- Modify: `internal/storage/index.go`
- Test: `internal/storage/storage_test.go`

**Steps:**
1. Change Index struct to use `map[int]*IndexEntry` instead of `map[int]*task.Task`:

```go
type Index struct {
    entries map[int]*IndexEntry  // Changed from tasks map[int]*task.Task
    dir     string
    storage *MarkdownStorage
}
```

2. Update `NewIndex()` to initialize `entries`:

```go
func NewIndex(dir string, storage *MarkdownStorage) *Index {
    return &Index{
        entries: make(map[int]*IndexEntry),
        dir:     dir,
        storage: storage,
    }
}
```

3. Update `Rebuild()` to convert tasks to entries:

```go
func (idx *Index) Rebuild() error {
    tasks, err := idx.storage.LoadAll()
    if err != nil {
        return err
    }

    idx.entries = make(map[int]*IndexEntry)
    for _, t := range tasks {
        idx.entries[t.ID] = taskToEntry(t)
    }

    return idx.Save()
}
```

4. Add `GetEntry()` method that returns entry from memory (metadata only):

```go
// GetEntry returns an entry by ID (metadata only, no description)
func (idx *Index) GetEntry(id int) (*IndexEntry, bool) {
    e, ok := idx.entries[id]
    return e, ok
}
```

5. Modify `Get()` to load full task from disk using storage:

```go
// Get returns a full task by ID (loads description from disk)
func (idx *Index) Get(id int) (*task.Task, bool) {
    if _, ok := idx.entries[id]; !ok {
        return nil, false
    }
    t, err := idx.storage.Load(id)
    if err != nil {
        return nil, false
    }
    return t, true
}
```

6. Update `Set()` to accept Task but store as IndexEntry:

```go
func (idx *Index) Set(t *task.Task) {
    idx.entries[t.ID] = taskToEntry(t)
}
```

7. Update `Delete()`:

```go
func (idx *Index) Delete(id int) {
    delete(idx.entries, id)
}
```

8. Update `All()` to convert entries to tasks (without descriptions):

```go
func (idx *Index) All() []*task.Task {
    tasks := make([]*task.Task, 0, len(idx.entries))
    for _, e := range idx.entries {
        tasks = append(tasks, entryToTask(e))
    }
    sort.Slice(tasks, func(i, j int) bool {
        return tasks[i].ID < tasks[j].ID
    })
    return tasks
}
```

9. Add helper to convert entry back to task (without description):

```go
func entryToTask(e *IndexEntry) *task.Task {
    return &task.Task{
        ID:        e.ID,
        ParentID:  e.ParentID,
        Title:     e.Title,
        Status:    e.Status,
        Priority:  e.Priority,
        Type:      e.Type,
        CreatedAt: e.CreatedAt,
        UpdatedAt: e.UpdatedAt,
        // Description intentionally empty
    }
}
```

10. Update `Filter()` to work with entries:

```go
func (idx *Index) Filter(status *task.Status, priority *task.Priority, taskType *string, parentID *int) []*task.Task {
    var result []*task.Task
    for _, e := range idx.entries {
        if status != nil && e.Status != *status {
            continue
        }
        if priority != nil && e.Priority != *priority {
            continue
        }
        if taskType != nil && e.Type != *taskType {
            continue
        }
        if parentID != nil {
            if *parentID == 0 {
                if e.ParentID != nil {
                    continue
                }
            } else {
                if e.ParentID == nil || *e.ParentID != *parentID {
                    continue
                }
            }
        }
        result = append(result, entryToTask(e))
    }
    sort.Slice(result, func(i, j int) bool {
        return result[i].ID < result[j].ID
    })
    return result
}
```

11. Update `NextTodo()` to work with entries (internal logic same, just use entries map)

12. Update `NextID()`, `GetSubtasks()`, `HasSubtasks()`, `SubtaskCounts()` to work with entries

13. Run all storage tests: `go test ./internal/storage/... -v`

14. Commit with message: `refactor(storage): use IndexEntry internally in Index`

**Verification:**
`go test ./internal/storage/... -v`